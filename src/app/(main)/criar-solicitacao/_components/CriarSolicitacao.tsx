"use client";

import React, { useState, useMemo } from "react";
import {
  BsPersonFill,
  BsDropletFill,
  BsGeoAltFill,
  BsImageFill,
  BsCheckCircleFill,
  BsArrowLeft,
  BsArrowRight,
} from "react-icons/bs";
import styles from "../styles.module.scss";
import { APIService, isAPISuccess } from "@/service/api/api";

export default function CriarSolicitacao() {
  const [currentStep, setCurrentStep] = useState(1);
  const totalSteps = 4;
  const api = useMemo(() => new APIService(), []);
  const [formData, setFormData] = useState({
    nome: "",
    telefone: "",
    tipoSanguineo: "",
    quantidade: 1,
    endereco: "",
    datainicio: "",
    datatermino: "",
    descricao: "",
  });

  const [isSubmitting, setIsSubmitting] = useState(false);

  const steps = [
    { number: 1, title: "Dados do Paciente", icon: BsPersonFill },
    { number: 2, title: "Doa√ß√£o", icon: BsDropletFill },
    { number: 3, title: "Local e Per√≠odo", icon: BsGeoAltFill },
    { number: 4, title: "Informa√ß√µes Extras", icon: BsImageFill },
  ];

  const handleNext = () => {
    if (currentStep < totalSteps) {
      setCurrentStep((s) => s + 1);
      // remove foco do elemento atual para evitar que o DOM reutilize o n√≥
      // e transforme o bot√£o em 'submit' durante o re-render
      try {
        (document.activeElement as HTMLElement)?.blur();
      } catch {}
    }
  };

  const handlePrevious = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);

    }
  };

  const handleChange = (field: string, value: any) => {
    setFormData({ ...formData, [field]: value });
  };

  // Mantemos o handler onSubmit do form com preventDefault para evitar submits
  // autom√°ticos (por Enter ou re-render). O envio real √© feito por
  // performSubmit(), chamado explicitamente pelo bot√£o.
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
  };

  const submitNonceRef = React.useRef<string | null>(null);

  const performSubmit = async (nonce?: string) => {
    // Require a matching nonce generated by the user's button click to proceed
    if (!nonce || submitNonceRef.current !== nonce) {
      return;
    }
    submitNonceRef.current = null;
    if (currentStep < totalSteps) {
      return;
    }
    if (isSubmitting) {
      return;
    }
    setIsSubmitting(true);
  
    const payload = {
      name: formData.nome,
      phone: formData.telefone,
      bloodType: formData.tipoSanguineo,
      quantity: Number(formData.quantidade),
      address: formData.endereco,
      startDate: formData.datainicio || null,
      endDate: formData.datatermino || null,
      description: formData.descricao || "",
    };

    try {
      const url = api.getDonationServiceUrl("donations");
      const result = await api.post(url, payload);
      if (!isMounted.current) return;
      if (isAPISuccess(result)) {
        setTimeout(() => {
          if (!isMounted.current) return;
          setFormData({
            nome: "",
            telefone: "",
            tipoSanguineo: "",
            quantidade: 1,
            endereco: "",
            datainicio: "",
            datatermino: "",
            descricao: "",
          });
          setCurrentStep(1);
        }, 50);
      } else {
        console.error("Erro ao criar solicita√ß√£o:", result.message);
      }
    } catch (error) {
          console.error("üí• Erro no envio:", error);
    } finally {
      if (isMounted.current) setIsSubmitting(false);
    }
  };
  const isMounted = React.useRef(true);
  const formRef = React.useRef<HTMLDivElement | null>(null);

  React.useEffect(() => {
    return () => {
      isMounted.current = false;
    };
  }, []);

  return (
    <main className={styles.container}>
      <div className={styles.content}>
        {/* Header */}
        <div className={styles.header}>
          <h1 className={styles.title}>
            Criar Solicita√ß√£o de
            <span className={styles.highlight}>Doa√ß√£o</span>
          </h1>
          <p className={styles.subtitle}>
            Preencha as informa√ß√µes necess√°rias para que doadores possam
            encontrar sua solicita√ß√£o e ajudar quem precisa.
          </p>
        </div>

        {/* Progress Stepper */}
        <div className={styles.stepper}>
          {steps.map((step, index) => {
            const StepIcon = step.icon;
            const isActive = currentStep === step.number;
            const isCompleted = currentStep > step.number;

            return (
              <div key={step.number} className={styles.stepItem}>
                <div
                  className={`${styles.stepCircle} ${
                    isActive ? styles.active : ""
                  } ${isCompleted ? styles.completed : ""}`}
                >
                  {isCompleted ? (
                    <BsCheckCircleFill className={styles.checkIcon} />
                  ) : (
                    <StepIcon className={styles.stepIcon} />
                  )}
                </div>
                <div className={styles.stepLabel}>
                  <span className={styles.stepNumber}>Passo {step.number}</span>
                  <span className={styles.stepTitle}>{step.title}</span>
                </div>
                {index < steps.length - 1 && (
                  <div
                    className={`${styles.stepLine} ${
                      isCompleted ? styles.completed : ""
                    }`}
                  />
                )}
              </div>
            );
          })}
        </div>

        {/* Form */}
        <div
          ref={(el) => { formRef.current = el as HTMLDivElement; return; }}
          role="form"
          onSubmit={handleSubmit as any}
          onKeyDown={(e) => {
            if (e.key === "Enter") {
                const target = e.target as HTMLElement;
                const tag = target.tagName.toLowerCase();
                const type = (target as HTMLInputElement).type;

                // Previne o submit se Enter for pressionado em qualquer lugar que n√£o seja um textarea
                // ou se o elemento focado n√£o for um bot√£o de submit expl√≠cito no √∫ltimo passo
                // Previne o submit se Enter for pressionado em qualquer lugar que n√£o seja um textarea
                // e se o currentStep n√£o for o √∫ltimo passo, ou se o elemento focado n√£o for um bot√£o de submit expl√≠cito
                if (tag !== "textarea" && !(tag === "button" && type === "submit" && currentStep === totalSteps)) {
                    e.preventDefault();
                    console.warn(`‚õî Enter bloqueado no campo: <${tag} type="${type}">. Submit prevented.`);
                }
            }
            }}
          className={styles.form}
        >
          <div className={styles.formCard}>
            {/* Step 1: Patient Data */}
            {currentStep === 1 && (
              <div className={styles.stepContent}>
                <h2 className={styles.stepHeading}>
                  <BsPersonFill className={styles.headingIcon} />
                  Dados do Paciente
                </h2>
                <div className={styles.formGrid}>
                  <div className={styles.formGroup}>
                    <label htmlFor="nome" className={styles.label}>
                      Nome do paciente
                      <span className={styles.required}>*</span>
                    </label>
                    <input
                        type="text"
                        className={styles.input}
                        id="nome"
                        placeholder="Digite o nome completo"
                        value={formData.nome}
                        onChange={(e) => handleChange("nome", e.target.value)}
                        required
                      />
                  </div>

                  <div className={styles.formGroup}>
                    <label htmlFor="telefone" className={styles.label}>
                      Telefone para contato
                      <span className={styles.required}>*</span>
                    </label>
                    <input
                      type="tel"
                      className={styles.input}
                      id="telefone"
                      placeholder="(00) 00000-0000"
                      value={formData.telefone}
                      onChange={(e) => handleChange("telefone", e.target.value)}
                      required
                    />
                    <span className={styles.helpText}>
                      N√∫mero para contato sobre a doa√ß√£o
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Step 2: Blood Info */}
            {currentStep === 2 && (
              <div className={styles.stepContent}>
                <h2 className={styles.stepHeading}>
                  <BsDropletFill className={styles.headingIcon} />
                  Informa√ß√µes sobre a Doa√ß√£o
                </h2>
                <div className={styles.formGrid}>
                  <div className={styles.formGroup}>
                    <label htmlFor="tipoSanguineo" className={styles.label}>
                      Tipo sangu√≠neo <span className={styles.required}>*</span>
                    </label>
                    <select
                      className={styles.select}
                      id="tipoSanguineo"
                      value={formData.tipoSanguineo}
                      onChange={(e) => handleChange("tipoSanguineo", e.target.value)}
                      required
                    >
                      <option value="" disabled>
                        Selecione o tipo sangu√≠neo
                      </option>
                      <option value="" disabled>Selecione o tipo sangu√≠neo</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                  </div>

                  <div className={styles.formGroup}>
                    <label htmlFor="quantidade" className={styles.label}>
                      Quantidade de bolsas
                      <span className={styles.required}>*</span>
                    </label>
                    <input
                        type="number"
                        className={styles.input}
                        id="quantidade"
                        placeholder="Ex: 2"
                        min="1"
                        value={formData.quantidade}
                        onChange={(e) => handleChange("quantidade", e.target.value)}
                        required
                      />
                    <span className={styles.helpText}>
                      Quantidade necess√°ria para a transfus√£o
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Step 3: Location & Period */}
            {currentStep === 3 && (
              <div className={styles.stepContent}>
                <h2 className={styles.stepHeading}>
                  <BsGeoAltFill className={styles.headingIcon} />
                  Local e Per√≠odo
                </h2>
                <div className={styles.formGrid}>
                  <div className={`${styles.formGroup} ${styles.fullWidth}`}>
                    <label htmlFor="endereco" className={styles.label}>
                      Endere√ßo para doa√ß√£o
                      <span className={styles.required}>*</span>
                    </label>
                    <input
                      type="text"
                      className={styles.input}
                      id="endereco"
                      placeholder="Hospital, cl√≠nica ou hemocentro"
                      value={formData.endereco}
                      onChange={(e) => handleChange("endereco", e.target.value)}
                      required
                    />
                    <span className={styles.helpText}>
                      Informe o local onde a doa√ß√£o deve ser realizada
                    </span>
                  </div>

                  <div className={styles.formGroup}>
                    <label htmlFor="datainicio" className={styles.label}>
                      Data de in√≠cio
                    </label>
                    <input
                      type="date"
                      className={styles.input}
                      id="datainicio"
                      value={formData.datainicio}
                      onChange={(e) => handleChange("datainicio", e.target.value)}
                    />
                  </div>

                  <div className={styles.formGroup}>
                    <label htmlFor="datatermino" className={styles.label}>
                      Data de t√©rmino
                    </label>
                    <input
                      type="date"
                      className={styles.input}
                      id="datatermino"
                      value={formData.datatermino}
                      onChange={(e) => handleChange("datatermino", e.target.value)}
                    />
                  </div>
                </div>
              </div>
            )}

            {/* Step 4: Extra Info */}
            {currentStep === 4 && (
              <div className={styles.stepContent}>
                <h2 className={styles.stepHeading}>
                  <BsImageFill className={styles.headingIcon} />
                  Informa√ß√µes Complementares
                </h2>
                <div className={styles.formGrid}>
                  <div className={`${styles.formGroup} ${styles.fullWidth}`}>
                    <label htmlFor="descricao" className={styles.label}>
                      Descri√ß√£o da solicita√ß√£o
                    </label>
                    <textarea
                      className={styles.textarea}
                      id="descricao"
                      rows={5}
                      placeholder="Adicione informa√ß√µes adicionais que possam ajudar os doadores (opcional)"
                      value={formData.descricao}
                      onChange={(e) => handleChange("descricao", e.target.value)}
                    ></textarea>
                    <span className={styles.helpText}>
                      Informa√ß√µes sobre a urg√™ncia, hist√≥rico ou condi√ß√µes
                      especiais
                    </span>
                  </div>

                  <div className={`${styles.formGroup} ${styles.fullWidth}`}>
                    <label htmlFor="formFile" className={styles.label}>
                      Foto do paciente (opcional)
                    </label>
                    <div className={styles.fileUpload}>
                      <input
                        className={styles.fileInput}
                        type="file"
                        id="formFile"
                        accept="image/*"
                      />
                      <label htmlFor="formFile" className={styles.fileLabel}>
                        <BsImageFill className={styles.fileIcon} />
                        <span className={styles.fileText}>
                          Clique para selecionar uma imagem
                        </span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Navigation Buttons */}
          <div className={styles.navigation}>
            {currentStep > 1 && (
              <button
                type="button"
                onClick={handlePrevious}
                onMouseDown={(e) => e.preventDefault()}
                className={`${styles.button} ${styles.buttonSecondary}`}
              >
                <BsArrowLeft className={styles.buttonIcon} />
                Voltar
              </button>
            )}

            {currentStep < totalSteps ? (
              <button
                type="button"
                onClick={handleNext}
                onMouseDown={(e) => e.preventDefault()}
                className={`${styles.button} ${styles.buttonPrimary}`}
              >
                Pr√≥ximo
                <BsArrowRight className={styles.buttonIcon} />
              </button>
            ) : (
              <button
                type="button"
                onClick={(e) => {
                  if (!(e as React.MouseEvent).isTrusted) {
                    console.warn("‚õî Click n√£o confi√°vel bloqueado (isTrusted=false)");
                    return;
                  }
                  const nonce = Math.random().toString(36).slice(2, 10);
                  submitNonceRef.current = nonce;
                  performSubmit(nonce);
                }}
                disabled={isSubmitting}
                className={`${styles.button} ${styles.buttonPrimary}`}
              >
                <BsCheckCircleFill className={styles.buttonIcon} />
                {isSubmitting ? "Enviando..." : "Criar Solicita√ß√£o"}
              </button>
            )}
          </div>
  </div>
      </div>
    </main>
  );
}
